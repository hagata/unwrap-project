
var fs = require('fs');
var path = require('path');
var exec = require('child_process').exec;

var persistPath = path.join(path.dirname(fs.realpathSync(__filename)), './persist.json');
var persistFile = fs.readFileSync(persistPath);
var persistData = JSON.parse(persistFile);


/**
 * List Command returns the list of projects
 * @return {array} Returns the list of project names
 */
module.exports.list = function(option) {

  console.log('Projects: ');
  for (index in persistData.projects){
    var projecetName = persistData.projects[index].project;
    var projectDirectory = persistData.projects[index].directory;

    if (option == 'dir'){
      console.log(' - ' + projecetName + ' | ' + projectDirectory);
    }else{
      console.log(" - " + projecetName)
    }
  }
}


/**
 * Accesses and parses the persistData json file
 * @return {object} the json object from persist.json
 */
module.exports.readPersist = function() {
  return persistData;
}

module.exports.add = function(projectName, directory) {

  //Check if that name is taken
  //if so, return.
  if(this.findProject(projectName) > -1){
    console.log('Oops…\n  \"%s\" already exists', projectName);
    return
  }
  
  //Check if a directory is supplied, otherwise set the current directory 
  if (!directory){
    directory = process.cwd()
  }
  
  var newProject = {
    "project": projectName,
    "directory": directory
  }

  //TODO: Prompt for confirmation?
  persistData.projects.push(newProject)
  this.writePersist(persistData);

  //Copy unwrap template
  var copyFile = path.join(path.dirname(fs.realpathSync(__filename)), './_unwrap.json')
  this.duplicateFile(copyFile, projectName, directory);

  console.log('Added - ' + projectName);
  
}

module.exports.remove = function(projectName) {
  console.log('Removing Project… \"' + projectName + '\"\n');
  //does that proj exist?
  var projectIndex = this.findProject(projectName);

  //if so, remove it
  if(projectIndex > -1){
    persistData.projects.splice(projectIndex, 1)
    this.writePersist(persistData);
  }else{
   console.log(' - \"' + projectName + '\"" does not exist.');
 }
};

module.exports.changeDirectory = function(projectName) {
  //check index of project
  //if it doesn't exist, return message
  console.log('changeing directory to root of \"%s\" ', projectName);
    if(this.findProject(projectName) <= -1){
    console.log('Oops…\n  \"%s\" does not exist. \n   Try adding the project or check \"unwrap ls\" for available projects', projectName);
    return
  }
  var projectIndex = this.findProject(projectName);
  var projectDirectory = persistData.projects[projectIndex].directory;
  //Change directory of current terminal window
  //
  var execFunc = 'open -a Terminal ' + projectDirectory;
  exec(execFunc)
  
//TODO: Add options to open in new window or tab.
}

module.exports.findProject = function(projectName) {
  var findProject = function(find) {
    return find.project;
  }
  var projectIndex = persistData.projects.map(findProject).indexOf(projectName);
  return projectIndex
}

module.exports.writePersist = function(updatedData) {
  var writePersist = JSON.stringify(updatedData, null, 2);
  fs.writeFileSync(persistPath, writePersist);
}


module.exports.duplicateFile = function(file, projectName, dir) {
  var readFile = file;
  var writeFile = dir +'/unwrap.json';

  // Read File
  fs.createReadStream(readFile)
    // Write File
    .pipe(fs.createWriteStream(writeFile));
}

